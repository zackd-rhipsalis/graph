const https=require("https"),qs=require("querystring"),request=require("request"),cors=require("cors"),express=require("express"),port=process.env.PORT||3e3,TOKEN=process.env.LINE_TOKEN,bitly_token=process.env.BITLY_TOKEN;let random=400,original="",push_status=!1;const app=express();function pushMsg(text,id){const msg=JSON.stringify({to:id,messages:[{type:"text",text:text}]}),headers={"Content-Type":"application/json",Authorization:"Bearer "+TOKEN},webhookOptions={hostname:"api.line.me",path:"/v2/bot/message/push",method:"POST",headers:headers,body:msg},request=https.request(webhookOptions,res=>{res.on("data",d=>{process.stdout.write(d)})});request.on("error",err=>{console.error(err)}),request.write(msg),request.end()}app.use(cors()).use(express.urlencoded({extended:!0})).use(express.json()).post("/webhook",(req,res)=>{res.send("HTTP POST request sent to the webhook URL!"),random=~~(899999*Math.random()+1e5);const userId=req.body.events[0].source.userId,ms=req.body.events[0].message.text;let text="";if("message"===req.body.events[0].type){text=ms.match(/発行/)||ms.match(/generate/i)||ms.match(/URL/i)||ms.match(/生成/)?"下記のサイトで特定したい相手の名前と元のURL、認証コードを入力してください\n※認証コードの有効期限は約30分です。有効期限が切れは場合はもう一度メッセージを送信して下さい。\n\nhttps://rhipsali.github.io/get_ip?userId="+userId+"\n\n認証コード: "+random:"URLを発行したい場合は「URLを発行したい」「URLを生成して」などと話しかけてみてください";const dataString=JSON.stringify({replyToken:req.body.events[0].replyToken,messages:[{type:"text",text:text}]}),headers={"Content-Type":"application/json",Authorization:"Bearer "+TOKEN},webhookOptions={hostname:"api.line.me",path:"/v2/bot/message/reply",method:"POST",headers:headers,body:dataString},request=https.request(webhookOptions,res=>{res.on("data",d=>{process.stdout.write(d)})});request.on("error",err=>{console.error(err)}),request.write(dataString),request.end()}}).post("/pass",(req,res)=>{"ぴやっほゃ"===req.body.text?res.send(JSON.stringify({pass:random})):res.sendStatus(415)}).post("/generated",(req,res)=>{const name=req.body.name,url=req.body.url,userId=req.query.userId||null,query={name:name,original:url,id:userId},longUrl="https://get-ip-nero.herokuapp.com/get/ip/nero?"+qs.stringify(query),req_url="https://api-ssl.bitly.com/v3/shorten?"+qs.stringify({access_token:bitly_token,longUrl:longUrl}),options={url:req_url,method:"GET",json:!0};request(options,(err,response,body)=>{if(err||200!==body.status_code)return void console.log(err);const generated=body.data.url||longUrl;res.send(JSON.stringify({access_url:generated}))})}).get("/get/ip/nero",(req,res)=>{const nom=req.query.name,id=req.query.id;original=req.query.original,res.sendFile(__dirname+"/open.html");const ip=req.headers["x-forwarded-for"]||req.connection.remoteAddress||req.connection.socket.remoteAddress||req.socket.remoteAddress||"0.0.0.0",str=ip.match(/[^0-9.]/g)?ip.replace(/[^0-9.]/g,""):ip;push_status=!(!id||"ja"!==req.headers["accept-language"]||"Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1"===req.headers["user-agent"]||"bitlybot/3.0 (+http://bit.ly/)"===req.headers["user-agent"]),push_status&&(pushMsg(`${nom}さんがURLにアクセスしました\n\nIPアドレス: ${str}\n\n使用デバイス:\n${req.headers["user-agent"]}`,id),console.log(`名前: ${nom}\nIPアドレス: ${str}`))}).get("/auth",(req,res)=>{const URL=original||"https://rhipsali.github.io/get_ip";res.send(JSON.stringify({url:URL}))}).listen(port,()=>console.log("listening on "+port));